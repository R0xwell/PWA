<!DOCTYPE html>
<html lang="es" ng-app="refugioApp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M√≥dulo Apoyos - Refugio Animal</title>

  <!-- AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="../css/index.css">

  <style>
    :root {
      --main-color: #4CAF50;
      --accent-color: #388E3C;
      --bg-color: #f9f9f9;
    }

    body {
      background: var(--bg-color);
      font-family: 'Segoe UI', sans-serif;
    }

    .container {
      background: white;
      padding: 2rem;
      margin: 2rem auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 900px;
    }

    .form-box {
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .form-box input {
      flex: 1;
      padding: 0.5rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .form-box button {
      background: var(--main-color);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .form-box button:hover {
      background: var(--accent-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.8rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: var(--main-color);
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    button.action {
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 4px;
      color: white;
    }

    button.edit { background-color: #2196F3; }
    button.delete { background-color: #f44336; }
    button.edit:hover { background-color: #1976D2; }
    button.delete:hover { background-color: #d32f2f; }

    .offline {
      color: red;
      font-weight: bold;
    }

    .online {
      color: green;
      font-weight: bold;
    }

    .offline-row {
      background-color: #fff3e0 !important;
    }

    /* Modal */
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
    }

    .modal input {
      width: 100%;
      margin-bottom: 0.8rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal button {
      width: 48%;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .modal .save {
      background: var(--main-color);
    }

    .modal .cancel {
      background: #f44336;
    }
  </style>
</head>

<body ng-controller="ApoyosCtrl">
<header>
  <div class="header-left">
    <div class="logo">
      <img src="../resources/veterinaria_bigotes.png" alt="Logo Refugio Animal">
    </div>
    <h1>Refugio Animal</h1>
  </div>

  <nav>
    <a href="./mascotas.html">Mascotas</a>
    <a href="./padrinos.html">Padrinos</a>
    <a href="./apoyos.html">Apoyos</a>
    <a href="./notifications.html">Notificaciones</a>
    <a href="#" ng-click="cerrarSesion()">Cerrar sesi√≥n</a>
  </nav>
</header>

<main>
  <div class="container">
    <h2>üí∞ Apoyos</h2>

    <p ng-class="offline ? 'offline' : 'online'">
      {{ offline ? '‚ö† Est√°s en modo offline (los apoyos se guardar√°n localmente)' : 'üü¢ Conectado al servidor' }}
    </p>

    <!-- Formulario de agregar/editar -->
    <div class="form-box">
      <input type="number" ng-model="newApoyo.idMascota" placeholder="ID Mascota (opcional)">
      <input type="number" ng-model="newApoyo.idPadrino" placeholder="ID Padrino (opcional)">
      <input type="number" ng-model="newApoyo.monto" placeholder="Monto (MXN)" required>
      <input type="text" ng-model="newApoyo.causa" placeholder="Causa del apoyo" required>

      <button ng-click="guardarApoyo()">
        {{ newApoyo.idApoyo ? 'Actualizar' : 'Agregar' }}
      </button>
      <button ng-if="newApoyo.idApoyo" ng-click="cancelarEdicion()">Cancelar</button>
    </div>

    <!-- Tabla -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>ID Mascota</th>
          <th>ID Padrino</th>
          <th>Monto</th>
          <th>Causa</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="apoyo in apoyos track by apoyo.idApoyo" ng-class="{'offline-row': apoyo.offline}">
          <td>{{apoyo.idApoyo}}</td>
          <td>{{apoyo.idMascota || 'N/A'}} <span ng-if="apoyo.offline">‚ö†Ô∏è</span></td>
          <td>{{apoyo.idPadrino || 'N/A'}}</td>
          <td>{{apoyo.monto | currency}}</td>
          <td>{{apoyo.causa || 'Sin causa registrada'}}</td>
          <td>
            <button class="action edit" ng-click="openEditModal(apoyo)">Editar</button>
            <button class="action delete" ng-click="removeApoyo(apoyo.idApoyo)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<!-- Modal de edici√≥n -->
<div class="modal-bg" id="editModal">
  <div class="modal">
    <h3>Editar Apoyo</h3>

    <input type="number" ng-model="editApoyo.idMascota" placeholder="ID Mascota">
    <input type="number" ng-model="editApoyo.idPadrino" placeholder="ID Padrino">
    <input type="number" ng-model="editApoyo.monto" placeholder="Monto (MXN)">
    <input type="text" ng-model="editApoyo.causa" placeholder="Causa">

    <div style="display:flex;justify-content:space-between;">
      <button class="save" ng-click="saveEdit()">Guardar</button>
      <button class="cancel" ng-click="closeEditModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- üî• Firebase Messaging -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYdFd-39KDzADVcfurLdT9_W2cAIChFRA",
  authDomain: "refugioanimal-b6096.firebaseapp.com",
  projectId: "refugioanimal-b6096",
  storageBucket: "refugioanimal-b6096.firebasestorage.app",
  messagingSenderId: "122878637057",
  appId: "1:122878637057:web:951a15ed750ce8fca27c00",
  measurementId: "G-80E0ZTSZWP"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// ===================================================================================
// üîî REGISTRAR SERVICE WORKER + PEDIR PERMISOS + OBTENER TOKEN
// ===================================================================================
async function registrarNotificaciones() {
  console.log("üîî Iniciando configuraci√≥n de notificaciones...");

  // 1Ô∏è‚É£ Solicitar permiso
  const permiso = await Notification.requestPermission();

  if (permiso !== "granted") {
    console.warn("üö´ Permiso de notificaciones denegado");
    return;
  }

  try {
    // 2Ô∏è‚É£ Registrar service worker correcto
    const registration = await navigator.serviceWorker.register("/testdashboard1/pwa-sw.js");

    console.log("‚úÖ SW registrado:", registration.scope);

    // 3Ô∏è‚É£ Obtener token FCM
    const token = await getToken(messaging, {
      vapidKey: "BJI5wstaYYYL2QXhnns6lVCFU8SzjT5_yUlEwJ5qrSk3v5dYiCe37cLyetXNQ0Cn3IlYHAKrrEhOdYQe1TwbVNo",
      serviceWorkerRegistration: registration
    });

    if (!token) {
      console.warn("‚ö†Ô∏è No se pudo obtener token FCM");
      return;
    }

    console.log("üîë Token FCM obtenido:", token);

    // 4Ô∏è‚É£ Guardar token en tu servidor
    await fetch("/testdashboard1/php/guardar_token.php", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "token=" + encodeURIComponent(token)
    });

    console.log("üì© Token guardado correctamente.");

  } catch (error) {
    console.error("‚ùå Error al registrar notificaciones:", error);
  }
}

// ===================================================================================
// üì® NOTIFICACIONES EN FOREGROUND (Cuando el usuario est√° usando la app)
// ===================================================================================
onMessage(messaging, (payload) => {
  console.log("üì® Notificaci√≥n recibida en foreground:", payload);

  const { title, body, icon } = payload.notification || {};

  const notificationData = {
    body: body || "Tienes una nueva notificaci√≥n",
    icon: icon || "/testdashboard1/resources/icon-512x512.png"
  };

  if (Notification.permission === "granted") {
    navigator.serviceWorker.ready.then((registration) => {
      registration.showNotification(title || "Notificaci√≥n", notificationData);
    }).catch((err) => {
      console.warn("‚ö†Ô∏è No se pudo usar el Service Worker:", err);
      new Notification(title || "Notificaci√≥n", notificationData); 
    });
  }
});

// ===================================================================================
// üöÄ INICIAR TODO
// ===================================================================================
window.addEventListener("DOMContentLoaded", registrarNotificaciones);

</script>

<script>
angular.module('refugioApp', [])
.controller('ApoyosCtrl', function($scope, $http, $window) {

  const apiUrl = "../php/apoyos.php";

  // ---------------------------------------------------------
  // üß† ESTADO INICIAL
  // ---------------------------------------------------------
  $scope.offline = !navigator.onLine;
  $scope.apoyos = JSON.parse(localStorage.getItem('apoyos')) || [];
  $scope.newApoyo = {};

  // Persistencia
  function guardarLocal() {
    localStorage.setItem('apoyos', JSON.stringify($scope.apoyos));
  }

  // ---------------------------------------------------------
  // üìå Cargar apoyos desde servidor
  // ---------------------------------------------------------
  $scope.cargarApoyos = function() {
    if ($scope.offline) return;

    $http.get(apiUrl).then(res => {
      $scope.apoyos = res.data;
      guardarLocal();
    }).catch(() => {
      $scope.offline = true;
    });
  };

  // ---------------------------------------------------------
  // ‚ûï AGREGAR o EDITAR apoyo
  // ---------------------------------------------------------
  $scope.guardarApoyo = function() {

    const isEdit = !!$scope.newApoyo.idApoyo;

    // -----------------------------------
    // ‚úè EDITAR (PUT REAL)
    // -----------------------------------
    if (isEdit) {

      const id = $scope.newApoyo.idApoyo;
      const idx = $scope.apoyos.findIndex(a => a.idApoyo == id);

      if (!$scope.offline && navigator.onLine) {

        $http.put(apiUrl, $scope.newApoyo).then(() => {
          $scope.apoyos[idx] = angular.copy($scope.newApoyo);
          guardarLocal();
          $scope.newApoyo = {};
        }).catch(() => {
          $scope.apoyos[idx] = { ...$scope.newApoyo, offlineEdit: true };
          guardarLocal();
        });

      } else {
        // offline
        $scope.apoyos[idx] = { ...$scope.newApoyo, offlineEdit: true };
        guardarLocal();
      }

      return;
    }

    // -----------------------------------
    // ‚ûï NUEVO APOYO (POST)
    // -----------------------------------
    if (!$scope.offline && navigator.onLine) {

      $http.post(apiUrl, $scope.newApoyo).then(res => {
        const nuevo = { ...$scope.newApoyo, idApoyo: res.data.idApoyo };
        $scope.apoyos.push(nuevo);
        guardarLocal();
        $scope.newApoyo = {};
      }).catch(() => {
        // solo offline si realmente no hay red
        const temp = {
          ...$scope.newApoyo,
          idApoyo: Date.now(), // temp ID local
          offline: true
        };
        $scope.apoyos.push(temp);
        guardarLocal();
        $scope.newApoyo = {};
      });

    } else {
      const temp = {
        ...$scope.newApoyo,
        idApoyo: Date.now(), // temp ID local
        offline: true
      };
      $scope.apoyos.push(temp);
      guardarLocal();
      $scope.newApoyo = {};
    }
  };

  // ---------------------------------------------------------
  // ‚úè MODAL DE EDICI√ìN
  // ---------------------------------------------------------
  $scope.openEditModal = (a) => {
    $scope.editApoyo = angular.copy(a);
    $scope.selectedApoyo = a;
    document.getElementById('editModal').style.display = 'flex';
  };

  $scope.closeEditModal = () => {
    document.getElementById('editModal').style.display = 'none';
  };

  $scope.saveEdit = function() {
    const data = angular.copy($scope.editApoyo);
    data.idApoyo = $scope.selectedApoyo.idApoyo;

    Object.assign($scope.selectedApoyo, data);

    if (!$scope.offline && navigator.onLine) {
      $http.put(apiUrl, data).then(() => {
        guardarLocal();
      }).catch(() => {
        $scope.selectedApoyo.offlineEdit = true;
        guardarLocal();
      });
    } else {
      $scope.selectedApoyo.offlineEdit = true;
      guardarLocal();
    }

    $scope.closeEditModal();
  };

  // ---------------------------------------------------------
  // ‚ùå ELIMINAR APOYO
  // ---------------------------------------------------------
  $scope.removeApoyo = function(id) {

    if (!confirm("¬øEliminar este apoyo?")) return;

    $scope.apoyos = $scope.apoyos.filter(a => a.idApoyo != id);
    guardarLocal();

    if (!$scope.offline && navigator.onLine) {
      $http.delete(apiUrl + "?id=" + id);
    }
  };

  // ---------------------------------------------------------
  // üîÅ SINCRONIZAR OFFLINE ‚Üí ONLINE
  // ---------------------------------------------------------
  function sincronizar() {

    const pendientes = $scope.apoyos.filter(a => a.offline || a.offlineEdit);

    pendientes.forEach(a => {

      // POST (nuevo)
      if (a.offline) {
        $http.post(apiUrl, a).then(res => {
          a.idApoyo = res.data.idApoyo;
          delete a.offline;
          guardarLocal();
        });
      }

      // PUT (edici√≥n)
      if (a.offlineEdit) {
        $http.put(apiUrl, a).then(() => {
          delete a.offlineEdit;
          guardarLocal();
        });
      }
    });
  }

  // ---------------------------------------------------------
  // üåê Cambios de conexi√≥n
  // ---------------------------------------------------------
  window.addEventListener("online", () => {
    $scope.offline = false;
    $scope.$applyAsync();
    sincronizar();
    $scope.cargarApoyos();
  });

  window.addEventListener("offline", () => {
    $scope.offline = true;
    $scope.$applyAsync();
  });

  // ---------------------------------------------------------
  // üöÄ Inicializar
  // ---------------------------------------------------------
  $scope.cargarApoyos();

  // üîí Cerrar sesi√≥n
  $scope.cerrarSesion = function() {
    if (confirm("¬øDeseas cerrar sesi√≥n?")) window.location.href="../index.html";
  };
});
</script>


<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/testdashboard1/pwa-sw.js', { scope: '/testdashboard1/' })
    .then(reg => console.log("‚úÖ SW registrado:", reg.scope))
    .catch(err => console.error("‚ùå Error al registrar SW:", err));
}
</script>

</body>
</html>
