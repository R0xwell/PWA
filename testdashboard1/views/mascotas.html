<!DOCTYPE html>
<html lang="es" ng-app="refugioApp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M√≥dulo Mascotas - Refugio Animal</title>

  <!-- AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <link rel="stylesheet" href="../css/index.css">

  <style>
    :root {
      --main-color: #4CAF50;
      --accent-color: #388E3C;
      --bg-color: #f9f9f9;
      --danger-color: #f44336;
      --info-color: #2196F3;
    }

    body {
      background: var(--bg-color);
      font-family: 'Segoe UI', sans-serif;
    }

    .container {
      background: white;
      padding: 2rem;
      margin: 2rem auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 950px;
    }

    .form-box {
      background: #e8f5e9;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .form-box input, .form-box select {
      flex: 1;
      padding: 0.5rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .form-box button {
      background: var(--main-color);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .form-box button:hover {
      background: var(--accent-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.8rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: var(--main-color);
      color: white;
    }

    tr.offline {
      background-color: #fff3cd !important;
    }

    tr.offline td {
      color: #795548;
    }

    button.action {
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 4px;
      color: white;
    }

    button.edit {
      background-color: var(--info-color);
    }

    button.delete {
      background-color: var(--danger-color);
    }

    button.edit:hover { background-color: #1976D2; }
    button.delete:hover { background-color: #d32f2f; }

    /* Modal */
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
    }

    .modal input, .modal select {
      width: 100%;
      margin-bottom: 0.8rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal button {
      width: 48%;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .modal .save {
      background: var(--main-color);
    }

    .modal .cancel {
      background: var(--danger-color);
    }
  </style>
</head>

<body ng-controller="MascotasCtrl">
  <header>
    <div class="header-left">
      <div class="logo">
        <img src="../resources/veterinaria_bigotes.png" alt="Logo Refugio Animal">
      </div>
      <h1>Refugio Animal</h1>
    </div>

    <nav>
      <a href="./mascotas.html">Mascotas</a>
      <a href="./padrinos.html">Padrinos</a>
      <a href="./apoyos.html">Apoyos</a>
      <a href="./notifications.html">Notificaciones</a>
      <a href="#" ng-click="cerrarSesion()">Cerrar sesi√≥n</a>
    </nav>
  </header>

  <main>
    <div class="container">
      <h2>üêæ Mascotas</h2>

      <p ng-if="offline" style="color:red;">‚ö† Est√°s en modo offline (usando datos locales)</p>
      <p ng-if="!offline" style="color:green;">üü¢ Conectado al servidor</p>

      <!-- Formulario de agregar -->
      <div class="form-box">
        <input type="text" ng-model="newMascota.nombre" placeholder="Nombre">
        <select ng-model="newMascota.sexo">
          <option value="">Sexo</option>
          <option value="M">M</option>
          <option value="F">F</option>
        </select>
        <input type="text" ng-model="newMascota.raza" placeholder="Raza">
        <input type="number" ng-model="newMascota.peso" placeholder="Peso (kg)">
        <input type="text" ng-model="newMascota.condiciones" placeholder="Condiciones">
        <button ng-click="addMascota()">Agregar</button>
      </div>

      <!-- Tabla -->
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Sexo</th>
            <th>Raza</th>
            <th>Peso</th>
            <th>Condiciones</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="mascota in mascotas track by (mascota.idMascota || $index)"
              ng-class="{'offline': mascota.offline}">
            <td>{{mascota.idMascota}}</td>
            <td>{{mascota.nombre}} <span ng-if="mascota.offline">‚ö†Ô∏è</span></td>
            <td>{{mascota.sexo}}</td>
            <td>{{mascota.raza || 'No especificada'}}</td>
            <td>{{mascota.peso}}</td>
            <td>{{mascota.condiciones || 'Ninguna'}}</td>
            <td>
              <button class="action edit" ng-click="openEditModal(mascota)">Editar</button>
              <button class="action delete" ng-click="removeMascota(mascota.idMascota)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal de edici√≥n -->
  <div class="modal-bg" id="editModal">
    <div class="modal">
      <h3>Editar Mascota</h3>
      <input type="text" ng-model="editMascotaData.nombre" placeholder="Nombre">
      <select ng-model="editMascotaData.sexo">
        <option value="M">M</option>
        <option value="F">F</option>
      </select>
      <input type="text" ng-model="editMascotaData.raza" placeholder="Raza">
      <input type="number" ng-model="editMascotaData.peso" placeholder="Peso (kg)">
      <input type="text" ng-model="editMascotaData.condiciones" placeholder="Condiciones">
      <div style="display:flex;justify-content:space-between;">
        <button class="save" ng-click="saveEdit()">Guardar</button>
        <button class="cancel" ng-click="closeEditModal()">Cancelar</button>
      </div>
    </div>
  </div>
<!-- üî• Firebase Messaging -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYdFd-39KDzADVcfurLdT9_W2cAIChFRA",
  authDomain: "refugioanimal-b6096.firebaseapp.com",
  projectId: "refugioanimal-b6096",
  storageBucket: "refugioanimal-b6096.firebasestorage.app",
  messagingSenderId: "122878637057",
  appId: "1:122878637057:web:951a15ed750ce8fca27c00",
  measurementId: "G-80E0ZTSZWP"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// ===================================================================================
// üîî REGISTRAR SERVICE WORKER + PEDIR PERMISOS + OBTENER TOKEN
// ===================================================================================
async function registrarNotificaciones() {
  console.log("üîî Iniciando configuraci√≥n de notificaciones...");

  // 1Ô∏è‚É£ Solicitar permiso
  const permiso = await Notification.requestPermission();

  if (permiso !== "granted") {
    console.warn("üö´ Permiso de notificaciones denegado");
    return;
  }

  try {
    // 2Ô∏è‚É£ Registrar service worker correcto
    const registration = await navigator.serviceWorker.register("/testdashboard1/pwa-sw.js");

    console.log("‚úÖ SW registrado:", registration.scope);

    // 3Ô∏è‚É£ Obtener token FCM
    const token = await getToken(messaging, {
      vapidKey: "BJI5wstaYYYL2QXhnns6lVCFU8SzjT5_yUlEwJ5qrSk3v5dYiCe37cLyetXNQ0Cn3IlYHAKrrEhOdYQe1TwbVNo",
      serviceWorkerRegistration: registration
    });

    if (!token) {
      console.warn("‚ö†Ô∏è No se pudo obtener token FCM");
      return;
    }

    console.log("üîë Token FCM obtenido:", token);

    // 4Ô∏è‚É£ Guardar token en tu servidor
    await fetch("/testdashboard1/php/guardar_token.php", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "token=" + encodeURIComponent(token)
    });

    console.log("üì© Token guardado correctamente.");

  } catch (error) {
    console.error("‚ùå Error al registrar notificaciones:", error);
  }
}

// ===================================================================================
// üì® NOTIFICACIONES EN FOREGROUND (Cuando el usuario est√° usando la app)
// ===================================================================================
onMessage(messaging, (payload) => {
  console.log("üì® Notificaci√≥n recibida en foreground:", payload);

  const { title, body, icon } = payload.notification || {};

  const notificationData = {
    body: body || "Tienes una nueva notificaci√≥n",
    icon: icon || "/testdashboard1/resources/icon-512x512.png"
  };

  if (Notification.permission === "granted") {
    navigator.serviceWorker.ready.then((registration) => {
      registration.showNotification(title || "Notificaci√≥n", notificationData);
    }).catch((err) => {
      console.warn("‚ö†Ô∏è No se pudo usar el Service Worker:", err);
      new Notification(title || "Notificaci√≥n", notificationData); 
    });
  }
});

// ===================================================================================
// üöÄ INICIAR TODO
// ===================================================================================
window.addEventListener("DOMContentLoaded", registrarNotificaciones);

</script>


<script>
angular.module('refugioApp', [])
.controller('MascotasCtrl', function($scope, $http, $window) {
  const apiUrl = "../php/mascotas.php";

  // üß† Mantener estado de conexi√≥n entre p√°ginas y sesiones
  const estadoGuardado = localStorage.getItem('offline');
  $scope.offline = estadoGuardado ? JSON.parse(estadoGuardado) : !$window.navigator.onLine;

  // üêæ Cargar mascotas guardadas localmente
  $scope.mascotas = JSON.parse(localStorage.getItem('mascotas')) || [];
  $scope.newMascota = {};

  // üü¢ Cargar mascotas desde servidor o usar las locales si est√° offline
  $scope.cargarMascotas = function() {
    if (!$scope.offline && $window.navigator.onLine) {
      $http.get(apiUrl).then(res => {
        if (Array.isArray(res.data)) {
          const serverMascotas = res.data;
          const localesPendientes = $scope.mascotas.filter(m => m.offline || m.offlineEdit);
          const idsServer = serverMascotas.map(m => m.idMascota);
          const combinadas = [...serverMascotas];

          // üß© Combinar las mascotas locales pendientes con las del servidor
          localesPendientes.forEach(lp => {
            if (!idsServer.includes(lp.idMascota)) combinadas.push(lp);
          });

          $scope.mascotas = combinadas;
          localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
        }
      }).catch(() => {
        console.warn("‚ö† No se pudo conectar al servidor ‚Äî modo offline activado");
        $scope.offline = true;
        localStorage.setItem('offline', true);
      });
    } else {
      console.warn("Modo offline ‚Äî usando datos de localStorage");
    }
  };

  // üê∂ Agregar nueva mascota
  $scope.addMascota = function() {
    if (!$scope.newMascota.nombre || !$scope.newMascota.sexo)
      return alert("Por favor completa nombre y sexo");

    // Generar ID local (m√°ximo actual + 1)
    const maxId = $scope.mascotas.length
      ? Math.max(...$scope.mascotas.map(m => m.idMascota || 0))
      : 0;
    const nextId = maxId + 1;

    const nueva = angular.copy($scope.newMascota);
    nueva.idMascota = nextId;

    if (!$scope.offline && $window.navigator.onLine) {
      // Guardar en servidor directamente
      $http.post(apiUrl, nueva).then(res => {
        if (res.data && res.data.idMascota)
          nueva.idMascota = res.data.idMascota;

        $scope.mascotas.push(nueva);
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
        $scope.newMascota = {};
      }).catch(() => {
        alert("Error al guardar en el servidor. Se guardar√° localmente.");
        nueva.offline = true;
        $scope.mascotas.push(nueva);
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      });
    } else {
      // Guardar localmente en modo offline
      nueva.offline = true;
      $scope.mascotas.push(nueva);
      localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      $scope.newMascota = {};
    }
  };

  // ‚úèÔ∏è Abrir modal de edici√≥n
  $scope.openEditModal = function(mascota) {
    $scope.editMascotaData = angular.copy(mascota);
    $scope.selectedMascota = mascota;
    document.getElementById('editModal').style.display = 'flex';
  };

  // ‚ùå Cerrar modal de edici√≥n
  $scope.closeEditModal = function() {
    document.getElementById('editModal').style.display = 'none';
  };

  // üíæ Guardar cambios de edici√≥n
  $scope.saveEdit = function() {
    angular.extend($scope.selectedMascota, $scope.editMascotaData);

    if (!$scope.offline && $window.navigator.onLine) {
      $http.put(apiUrl, $scope.selectedMascota).then(() => {
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      }).catch(() => {
        alert("Error al editar en servidor ‚Äî se guardar√° localmente.");
        $scope.selectedMascota.offlineEdit = true;
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      });
    } else {
      $scope.selectedMascota.offlineEdit = true;
      localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
    }

    $scope.closeEditModal();
  };

  // üóëÔ∏è Eliminar mascota
  $scope.removeMascota = function(idMascota) {
    if (!confirm("¬øSeguro que deseas eliminar esta mascota?")) return;

    if (!$scope.offline && $window.navigator.onLine) {
      $http.delete(apiUrl + "?id=" + idMascota).then(() => {
        $scope.mascotas = $scope.mascotas.filter(m => m.idMascota !== idMascota);
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      }).catch(() => {
        alert("Error al eliminar en servidor ‚Äî se eliminar√° localmente.");
        $scope.mascotas = $scope.mascotas.filter(m => m.idMascota !== idMascota);
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      });
    } else {
      // Eliminar directamente del almacenamiento local
      $scope.mascotas = $scope.mascotas.filter(m => m.idMascota !== idMascota);
      localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
    }
  };

  // üîÅ Sincronizar datos cuando vuelve la conexi√≥n
  function sincronizarDatos() {
    const pendientes = $scope.mascotas.filter(m => m.offline || m.offlineEdit);
    if (!pendientes.length) return;

    pendientes.forEach(m => {
      $http.post(apiUrl, m).then(() => {
        delete m.offline;
        delete m.offlineEdit;
        localStorage.setItem('mascotas', JSON.stringify($scope.mascotas));
      }).catch(() => {
        console.warn("No se pudo sincronizar mascota:", m.nombre);
      });
    });
  }

  // üåê Detectar cambios de conexi√≥n (persistentes)
  $window.addEventListener('online', () => {
    console.log("üü¢ Conectado a internet");
    $scope.offline = false;
    localStorage.setItem('offline', false);
    $scope.$applyAsync();
    sincronizarDatos();
    $scope.cargarMascotas();
  });

  $window.addEventListener('offline', () => {
    console.log("üî¥ Sin conexi√≥n detectada");
    $scope.offline = true;
    localStorage.setItem('offline', true);
    $scope.$applyAsync();
  });

  // üöÄ Inicializar cargando datos
  $scope.cargarMascotas();
    // üîí Cerrar sesi√≥n
  $scope.cerrarSesion = function() {
    if (confirm("¬øDeseas cerrar sesi√≥n?")) window.location.href="../index.html";
  };
});
</script>

  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/testdashboard1/pwa-sw.js', { scope: '/testdashboard1/' })
      .then(reg => console.log("‚úÖ SW registrado:", reg.scope))
      .catch(err => console.error("‚ùå Error al registrar SW:", err));
  }
  </script>
  
</body>
</html>
